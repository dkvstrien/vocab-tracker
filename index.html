<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>German Vocabulary Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f3f4f6;
        }

        body.dark {
            background: #1f2937;
            color: #f9fafb;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .header {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 12px 12px 0 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        body.dark .tabs {
            background: #374151;
        }

        .tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            font-size: 0.95rem;
            color: #6b7280;
        }

        body.dark .tab {
            color: #d1d5db;
        }

        .tab:hover {
            background: #f9fafb;
            color: #374151;
        }

        body.dark .tab:hover {
            background: #4b5563;
            color: #f9fafb;
        }

        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: #eff6ff;
        }

        body.dark .tab.active {
            background: #1e40af;
            color: white;
        }

        .content {
            background: white;
            padding: 2rem;
            border-radius: 0 0 12px 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            min-height: 500px;
        }

        body.dark .content {
            background: #374151;
        }

        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
            transition: border-color 0.3s;
        }

        .upload-area:hover {
            border-color: #3b82f6;
        }

        .file-input {
            margin: 1rem 0;
        }

        .file-input input {
            display: none;
        }

        .file-input label {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: #3b82f6;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .file-input label:hover {
            background: #2563eb;
        }

        .textarea {
            width: 100%;
            min-height: 150px;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            transition: border-color 0.3s;
            background: white;
            color: #374151;
        }

        body.dark .textarea {
            background: #4b5563;
            border-color: #6b7280;
            color: #f9fafb;
        }

        .textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.3s;
            margin: 0.25rem;
        }

        .button-primary {
            background: #3b82f6;
            color: white;
        }

        .button-primary:hover {
            background: #2563eb;
        }

        .button-success {
            background: #10b981;
            color: white;
        }

        .button-success:hover {
            background: #059669;
        }

        .button-secondary {
            background: #6b7280;
            color: white;
        }

        .button-secondary:hover {
            background: #4b5563;
        }

        .button-warning {
            background: #f59e0b;
            color: white;
        }

        .button-warning:hover {
            background: #d97706;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3b82f6;
        }

        body.dark .stat-card {
            background: #4b5563;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3b82f6;
        }

        .stat-label {
            color: #6b7280;
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        body.dark .stat-label {
            color: #d1d5db;
        }

        .word-tag {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            border: 1px solid;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.25rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .word-tag:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .word-tag.new {
            background: #fef2f2;
            border-color: #fecaca;
            color: #dc2626;
        }

        .word-tag.learning {
            background: #fffbeb;
            border-color: #fde68a;
            color: #d97706;
        }

        .word-tag.known {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #16a34a;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        body.dark .empty-state {
            color: #d1d5db;
        }

        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 1rem 0;
        }

        body.dark .progress-bar {
            background: #6b7280;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.5s ease;
        }

        .vocab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .vocab-card {
            background: #f9fafb;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
        }

        body.dark .vocab-card {
            background: #4b5563;
            border-color: #6b7280;
        }

        .vocab-card h3 {
            margin-bottom: 1rem;
            color: #374151;
        }

        body.dark .vocab-card h3 {
            color: #f9fafb;
        }

        .vocab-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .vocab-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            margin: 0.25rem 0;
            background: white;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }

        body.dark .vocab-item {
            background: #374151;
            border-color: #6b7280;
            color: #f9fafb;
        }

        .dark-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: #374151;
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1000;
            transition: background 0.3s;
            font-size: 1.2rem;
        }

        .dark-toggle:hover {
            background: #1f2937;
        }

        .hidden {
            display: none;
        }

        .reading-text {
            line-height: 1.8;
            font-size: 1.1rem;
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: #fafafa;
        }

        body.dark .reading-text {
            background: #4b5563;
            border-color: #6b7280;
            color: #f9fafb;
        }

        .reading-word {
            cursor: pointer;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            transition: all 0.2s;
            display: inline-block;
            min-height: 1.5rem;
        }

        .reading-word:hover {
            background: #dbeafe;
            transform: scale(1.05);
        }

        body.dark .reading-word:hover {
            background: #1e40af;
        }

        .reading-word.known {
            background: #f0fdf4;
            color: #166534;
        }

        body.dark .reading-word.known {
            background: #166534;
            color: #bbf7d0;
        }

        .reading-word.learning {
            background: #fffbeb;
            color: #92400e;
        }

        body.dark .reading-word.learning {
            background: #92400e;
            color: #fde68a;
        }

        .reading-word.new {
            background: #fef2f2;
            color: #dc2626;
        }

        body.dark .reading-word.new {
            background: #dc2626;
            color: #fecaca;
        }

        .reading-word.selected {
            outline: 2px solid #3b82f6;
            outline-offset: 1px;
        }

        .word-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            z-index: 1000;
            min-width: 300px;
            max-width: 90vw;
        }

        body.dark .word-popup {
            background: #374151;
            color: #f9fafb;
        }

        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .library-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            transition: all 0.3s;
        }

        body.dark .library-item {
            background: #4b5563;
            border-color: #6b7280;
        }

        .library-item:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .library-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        body.dark .library-title {
            color: #f9fafb;
        }

        .library-meta {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 1rem;
        }

        body.dark .library-meta {
            color: #d1d5db;
        }

        .reading-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 1rem 0;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
        }

        body.dark .reading-controls {
            background: #4b5563;
        }

        .page-input {
            width: 60px;
            padding: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
        }

        body.dark .page-input {
            background: #374151;
            border-color: #6b7280;
            color: #f9fafb;
        }

        .reading-header {
            background: #eff6ff;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        body.dark .reading-header {
            background: #1e40af;
        }

        .reading-header h3 {
            color: #1e40af;
            margin-bottom: 0.5rem;
        }

        body.dark .reading-header h3 {
            color: white;
        }

        .reading-header .meta {
            font-size: 0.9rem;
            color: #3b82f6;
        }

        body.dark .reading-header .meta {
            color: #93c5fd;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }
            .header h1 {
                font-size: 2rem;
            }
            .content {
                padding: 1rem;
            }
            .tabs {
                overflow-x: auto;
            }
            .tab {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .vocab-grid {
                grid-template-columns: 1fr;
            }
            .library-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <button class="dark-toggle" onclick="toggleDarkMode()" title="Toggle Dark Mode">🌙</button>
    
    <div class="container">
        <div class="header">
            <h1>📖 German Vocab Tracker</h1>
            <p>Upload texts and automatically track your German vocabulary progress</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('upload')">📊 Text Analysis</button>
            <button class="tab" onclick="showTab('library')">📚 Library</button>
            <button class="tab" onclick="showTab('reading')">👁️ Reading</button>
            <button class="tab" onclick="showTab('vocab')">📝 Vocabulary</button>
            <button class="tab" onclick="showTab('stats')">📈 Statistics</button>
        </div>

        <div class="content">
            <!-- Upload Tab -->
            <div id="upload-content" class="tab-content">
                <h2>Analyze German Text</h2>
                
                <div class="upload-area">
                    <div class="file-input">
                        <label for="file-upload">📁 Upload Text File</label>
                        <input id="file-upload" type="file" accept=".txt,.srt,.vtt" onchange="handleFileUpload(event)">
                    </div>
                    <p>Supports: .txt, .srt (subtitles), .vtt</p>
                </div>

                <div style="text-align: center; margin: 1rem 0; color: #6b7280;">or</div>

                <textarea id="text-input" class="textarea" placeholder="Paste your German text here..." oninput="analyzeText()"></textarea>

                <div style="margin: 1rem 0;">
                    <button class="button button-success" onclick="exportData()">💾 Export Data</button>
                    <button class="button button-secondary" onclick="document.getElementById('import-file').click()">📂 Import Data</button>
                    <input id="import-file" type="file" accept=".json" onchange="importData(event)" style="display: none;">
                </div>

                <div id="analysis-results" class="hidden">
                    <h3>Text Analysis Results</h3>
                    <div id="text-title"></div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div id="total-words" class="stat-number">0</div>
                            <div class="stat-label">Total Words</div>
                        </div>
                        <div class="stat-card">
                            <div id="unique-words" class="stat-number">0</div>
                            <div class="stat-label">Unique Words</div>
                        </div>
                        <div class="stat-card">
                            <div id="known-percentage" class="stat-number">0%</div>
                            <div class="stat-label">Known</div>
                        </div>
                        <div class="stat-card">
                            <div id="new-words" class="stat-number">0</div>
                            <div class="stat-label">New Words</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div id="word-categories"></div>
                </div>
            </div>

            <!-- Library Tab -->
            <div id="library-content" class="tab-content hidden">
                <h2>Text Library</h2>
                <div id="library-list">
                    <div class="empty-state">
                        <div class="icon">📚</div>
                        <h3>No texts in your library yet</h3>
                        <p>Upload texts in the Text Analysis tab to get started</p>
                    </div>
                </div>
            </div>

            <!-- Reading Tab -->
            <div id="reading-content" class="tab-content hidden">
                <h2>Reading Mode</h2>
                <div id="reading-area">
                    <div class="empty-state">
                        <div class="icon">👁️</div>
                        <h3>No text selected</h3>
                        <p>Choose a text from your library to start reading</p>
                    </div>
                </div>
            </div>

            <!-- Vocabulary Tab -->
            <div id="vocab-content" class="tab-content hidden">
                <h2>Vocabulary Management</h2>
                
                <div style="margin-bottom: 2rem; padding: 1rem; background: #f9fafb; border-radius: 8px;">
                    <h3>Add New Word</h3>
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
                        <input id="new-word" type="text" placeholder="Enter German word..." style="flex: 1; min-width: 200px; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                        <select id="word-level" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 4px;">
                            <option value="1">Learning</option>
                            <option value="2">Known</option>
                        </select>
                        <button class="button button-primary" onclick="addCustomWord()">Add</button>
                    </div>
                </div>

                <div class="vocab-grid">
                    <div class="vocab-card">
                        <h3>✅ Known Words (<span id="known-count">0</span>)</h3>
                        <div id="known-list" class="vocab-list"></div>
                    </div>
                    <div class="vocab-card">
                        <h3>📝 Learning Words (<span id="learning-count">0</span>)</h3>
                        <div id="learning-list" class="vocab-list"></div>
                    </div>
                    <div class="vocab-card">
                        <h3>🆕 New Words (<span id="new-count">0</span>)</h3>
                        <div id="new-list" class="vocab-list"></div>
                    </div>
                </div>
            </div>

            <!-- Statistics Tab -->
            <div id="stats-content" class="tab-content hidden">
                <h2>Vocabulary Statistics</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div id="stats-known" class="stat-number">0</div>
                        <div class="stat-label">Known Words</div>
                    </div>
                    <div class="stat-card">
                        <div id="stats-learning" class="stat-number">0</div>
                        <div class="stat-label">Learning</div>
                    </div>
                    <div class="stat-card">
                        <div id="stats-total" class="stat-number">0</div>
                        <div class="stat-label">Total Vocabulary</div>
                    </div>
                    <div class="stat-card">
                        <div id="stats-looked-up" class="stat-number">0</div>
                        <div class="stat-label">Words Looked Up</div>
                    </div>
                </div>

                <div id="current-text-stats" class="hidden">
                    <h3>Current Text Difficulty</h3>
                    <div class="progress-bar">
                        <div id="text-progress-fill" class="progress-fill" style="width: 0%"></div>
                    </div>
                    <div style="text-align: center; margin-top: 0.5rem; font-weight: bold; color: #374151;">
                        <span id="text-difficulty">0</span>% comprehension level
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Word Popup -->
    <div id="word-overlay" class="overlay hidden" onclick="closeWordPopup()"></div>
    <div id="word-popup" class="word-popup hidden">
        <h3>Word Lookup</h3>
        <div style="margin: 1rem 0;">
            <div id="popup-word" style="font-size: 1.5rem; font-weight: bold; color: #3b82f6; margin-bottom: 0.5rem;"></div>
            <div id="popup-translation" style="color: #6b7280; margin-bottom: 1rem;"></div>
        </div>
        <div style="margin: 1rem 0; font-size: 0.9rem;">
            <div>Current Level: <span id="popup-level"></span></div>
            <div>Times Looked Up: <span id="popup-lookups">0</span></div>
        </div>
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem; flex-wrap: wrap;">
            <button class="button button-warning" onclick="updateWordLevel(currentWord, 1)">📝 Learning</button>
            <button class="button button-success" onclick="updateWordLevel(currentWord, 2)">✅ Known</button>
            <button class="button button-secondary" onclick="closeWordPopup()">Close</button>
        </div>
    </div>

    <script>
        // Global state
        let vocabulary = new Map();
        let currentText = '';
        let currentTextTitle = '';
        let currentTextId = '';
        let analysis = null;
        let lookupHistory = new Map();
        let textLibrary = new Map();
        let readCounts = new Map();
        let readingGoals = new Map();
        let currentWord = null;
        let darkMode = false;
        let currentPage = 0;
        let wordsPerPage = 200;

        // German dictionary (expanded)
        const germanDictionary = {
            'hallo': 'hello', 'welt': 'world', 'haus': 'house', 'katze': 'cat', 'hund': 'dog',
            'wasser': 'water', 'essen': 'to eat / food', 'trinken': 'to drink', 'gehen': 'to go',
            'kommen': 'to come', 'sehen': 'to see', 'hören': 'to hear', 'sprechen': 'to speak',
            'lieben': 'to love', 'leben': 'to live', 'arbeiten': 'to work', 'schlafen': 'to sleep',
            'lesen': 'to read', 'schreiben': 'to write', 'lernen': 'to learn', 'verstehen': 'to understand',
            'heute': 'today', 'gestern': 'yesterday', 'morgen': 'tomorrow', 'zeit': 'time',
            'jahr': 'year', 'tag': 'day', 'nacht': 'night', 'abend': 'evening',
            'klein': 'small', 'groß': 'big', 'gut': 'good', 'schlecht': 'bad',
            'neu': 'new', 'alt': 'old', 'schnell': 'fast', 'langsam': 'slow',
            'freund': 'friend', 'frau': 'woman', 'mann': 'man', 'kind': 'child',
            'mutter': 'mother', 'vater': 'father', 'schwester': 'sister', 'bruder': 'brother',
            'stadt': 'city', 'land': 'country', 'auto': 'car', 'buch': 'book',
            'musik': 'music', 'film': 'film', 'restaurant': 'restaurant', 'hotel': 'hotel'
        };

        // Initialize app
        function initApp() {
            // Load common German words
            const commonWords = [
                ['der', 2], ['die', 2], ['das', 2], ['und', 2], ['ich', 2], ['du', 2],
                ['er', 2], ['sie', 2], ['es', 2], ['wir', 2], ['ihr', 2], ['ist', 2],
                ['sind', 2], ['haben', 2], ['hatte', 2], ['war', 2], ['waren', 2],
                ['ein', 2], ['eine', 2], ['einen', 2], ['einer', 2], ['mit', 2],
                ['zu', 2], ['in', 2], ['auf', 2], ['von', 2], ['für', 2], ['nicht', 2],
                ['aber', 2], ['auch', 2], ['nur', 2], ['noch', 2], ['schon', 2],
                ['kann', 2], ['will', 2], ['soll', 2], ['muss', 2], ['darf', 2]
            ];

            // Load saved data or use defaults
            const savedVocab = localStorage.getItem('germanVocab');
            if (savedVocab) {
                vocabulary = new Map(JSON.parse(savedVocab));
                // Merge with common words
                commonWords.forEach(([word, level]) => {
                    if (!vocabulary.has(word)) {
                        vocabulary.set(word, level);
                    }
                });
            } else {
                vocabulary = new Map(commonWords);
            }

            const savedLookups = localStorage.getItem('lookupHistory');
            if (savedLookups) {
                lookupHistory = new Map(JSON.parse(savedLookups));
            }

            const savedLibrary = localStorage.getItem('textLibrary');
            if (savedLibrary) {
                textLibrary = new Map(JSON.parse(savedLibrary));
            }

            const savedReadCounts = localStorage.getItem('readCounts');
            if (savedReadCounts) {
                readCounts = new Map(JSON.parse(savedReadCounts));
            }

            const savedGoals = localStorage.getItem('readingGoals');
            if (savedGoals) {
                readingGoals = new Map(JSON.parse(savedGoals));
            }

            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode) {
                darkMode = JSON.parse(savedDarkMode);
                if (darkMode) {
                    document.body.classList.add('dark');
                    document.querySelector('.dark-toggle').textContent = '☀️';
                }
            }

            updateVocabDisplay();
            updateStatsDisplay();
            updateLibraryDisplay();
            saveData();
        }

        // Utility functions
        function cleanWord(word) {
            return word.toLowerCase()
                .replace(/[.,!?;:"()[\]{}—–-]/g, '')
                .replace(/[0-9]/g, '')
                .trim();
        }

        function saveData() {
            localStorage.setItem('germanVocab', JSON.stringify([...vocabulary]));
            localStorage.setItem('lookupHistory', JSON.stringify([...lookupHistory]));
            localStorage.setItem('textLibrary', JSON.stringify([...textLibrary]));
            localStorage.setItem('readCounts', JSON.stringify([...readCounts]));
            localStorage.setItem('readingGoals', JSON.stringify([...readingGoals]));
            localStorage.setItem('darkMode', JSON.stringify(darkMode));
        }

        function getTranslation(word) {
            return germanDictionary[word.toLowerCase()] || 'Translation not available';
        }

        // Tab management
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-content').classList.remove('hidden');
            
            // Add active class to selected tab (find the clicked tab)
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach((tab, index) => {
                if (tab.textContent.includes(getTabLabel(tabName))) {
                    tab.classList.add('active');
                }
            });
        }

        function getTabLabel(tabName) {
            const labels = {
                'upload': 'Text Analysis',
                'library': 'Library',
                'reading': 'Reading',
                'vocab': 'Vocabulary',
                'stats': 'Statistics'
            };
            return labels[tabName] || tabName;
        }

        // Dark mode toggle
        function toggleDarkMode() {
            darkMode = !darkMode;
            document.body.classList.toggle('dark');
            document.querySelector('.dark-toggle').textContent = darkMode ? '☀️' : '🌙';
            saveData();
        }

        // File upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    let text = e.target.result;
                    let title = file.name;

                    // Clean up text
                    text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

                    // Save to library
                    const textId = Date.now().toString();
                    textLibrary.set(textId, {
                        title: title,
                        content: text,
                        dateAdded: new Date().toISOString(),
                        wordCount: text.split(/\s+/).length
                    });

                    currentText = text;
                    currentTextTitle = title;
                    currentTextId = textId;
                    document.getElementById('text-input').value = text;
                    
                    analyzeText();
                    saveData();
                    updateLibraryDisplay();
                };
                reader.readAsText(file, 'UTF-8');
            }
        }

        // Text analysis
        function analyzeText() {
            const text = document.getElementById('text-input').value;
            currentText = text;
            
            if (!text.trim()) {
                document.getElementById('analysis-results').classList.add('hidden');
                return;
            }

            const words = text.split(/\s+/)
                .map(cleanWord)
                .filter(word => word.length > 0);

            const uniqueWords = [...new Set(words)];
            const wordStats = {
                total: words.length,
                unique: uniqueWords.length,
                known: 0,
                learning: 0,
                new: 0,
                wordDetails: []
            };

            uniqueWords.forEach(word => {
                const level = vocabulary.get(word) || 0;
                const count = words.filter(w => w === word).length;
                
                wordStats.wordDetails.push({ word, level, count });
                
                if (level === 2) wordStats.known++;
                else if (level === 1) wordStats.learning++;
                else wordStats.new++;
            });

            wordStats.wordDetails.sort((a, b) => {
                if (a.level !== b.level) return a.level - b.level;
                return b.count - a.count;
            });

            analysis = wordStats;
            displayAnalysis();
            updateStatsDisplay();
        }

        function displayAnalysis() {
            document.getElementById('analysis-results').classList.remove('hidden');
            
            if (currentTextTitle) {
                document.getElementById('text-title').innerHTML = 
                    `<div style="margin-bottom: 1rem; padding: 1rem; background: #eff6ff; border-radius: 8px;">
                        <h4 style="color: #1e40af;">📖 ${currentTextTitle}</h4>
                    </div>`;
            } else {
                document.getElementById('text-title').innerHTML = '';
            }

            // Update stats
            document.getElementById('total-words').textContent = analysis.total;
            document.getElementById('unique-words').textContent = analysis.unique;
            document.getElementById('new-words').textContent = analysis.new;
            
            const knownPercentage = Math.round(((analysis.known + analysis.learning * 0.5) / analysis.unique) * 100);
            document.getElementById('known-percentage').textContent = knownPercentage + '%';
            document.getElementById('progress-fill').style.width = knownPercentage + '%';

            // Display word categories
            displayWordCategories();
        }

        function displayWordCategories() {
            const categoriesDiv = document.getElementById('word-categories');
            categoriesDiv.innerHTML = '';

            const levels = [
                { level: 0, label: 'New Words', class: 'new' },
                { level: 1, label: 'Learning Words', class: 'learning' },
                { level: 2, label: 'Known Words', class: 'known' }
            ];

            levels.forEach(({ level, label, class: className }) => {
                const wordsAtLevel = analysis.wordDetails.filter(w => w.level === level);
                if (wordsAtLevel.length === 0) return;

                const section = document.createElement('div');
                section.style.marginBottom = '2rem';
                
                const header = document.createElement('h4');
                header.textContent = `${label} (${wordsAtLevel.length})`;
                header.style.marginBottom = '1rem';
                section.appendChild(header);

                const wordsContainer = document.createElement('div');
                wordsContainer.style.display = 'flex';
                wordsContainer.style.flexWrap = 'wrap';
                wordsContainer.style.gap = '0.5rem';

                wordsAtLevel.slice(0, 20).forEach(({ word, count }) => {
                    const wordTag = document.createElement('div');
                    wordTag.className = `word-tag ${className}`;
                    wordTag.innerHTML = `
                        ${word} <span style="opacity: 0.7;">(${count}x)</span>
                        <div style="display: flex; gap: 0.25rem;">
                            ${level < 2 ? `<button onclick="updateWordLevel('${word}', ${level + 1})" style="background: none; border: none; color: #16a34a; cursor: pointer;">✓</button>` : ''}
                            ${level > 0 ? `<button onclick="updateWordLevel('${word}', ${level - 1})" style="background: none; border: none; color: #dc2626; cursor: pointer;">✗</button>` : ''}
                        </div>
                    `;
                    wordsContainer.appendChild(wordTag);
                });

                if (wordsAtLevel.length > 20) {
                    const moreDiv = document.createElement('div');
                    moreDiv.style.color = '#6b7280';
                    moreDiv.style.fontStyle = 'italic';
                    moreDiv.textContent = `... and ${wordsAtLevel.length - 20} more`;
                    wordsContainer.appendChild(moreDiv);
                }

                section.appendChild(wordsContainer);
                categoriesDiv.appendChild(section);
            });
        }

        // Vocabulary management
        function updateWordLevel(word, newLevel) {
            if (newLevel === 0) {
                vocabulary.delete(word);
            } else {
                vocabulary.set(word, newLevel);
            }
            
            saveData();
            updateVocabDisplay();
            updateStatsDisplay();
            
            if (analysis) {
                // Recalculate analysis with new word levels
                const wordDetail = analysis.wordDetails.find(w => w.word === word);
                if (wordDetail) {
                    // Update counts
                    if (wordDetail.level === 2) analysis.known--;
                    else if (wordDetail.level === 1) analysis.learning--;
                    else analysis.new--;
                    
                    wordDetail.level = newLevel;
                    
                    if (newLevel === 2) analysis.known++;
                    else if (newLevel === 1) analysis.learning++;
                    else analysis.new++;
                    
                    displayAnalysis();
                }
            }
            
            if (currentWord === word) {
                updateWordPopup();
            }
        }

        function addCustomWord() {
            const wordInput = document.getElementById('new-word');
            const levelSelect = document.getElementById('word-level');
            
            const word = cleanWord(wordInput.value);
            const level = parseInt(levelSelect.value);
            
            if (word) {
                vocabulary.set(word, level);
                wordInput.value = '';
                saveData();
                updateVocabDisplay();
                updateStatsDisplay();
            }
        }

        function updateVocabDisplay() {
            const levels = [
                { level: 2, container: 'known-list', count: 'known-count' },
                { level: 1, container: 'learning-list', count: 'learning-count' },
                { level: 0, container: 'new-list', count: 'new-count' }
            ];

            levels.forEach(({ level, container, count }) => {
                const words = Array.from(vocabulary.entries())
                    .filter(([word, wordLevel]) => wordLevel === level)
                    .sort(([a], [b]) => a.localeCompare(b));

                document.getElementById(count).textContent = words.length;

                const listContainer = document.getElementById(container);
                listContainer.innerHTML = '';

                words.forEach(([word, wordLevel]) => {
                    const item = document.createElement('div');
                    item.className = 'vocab-item';
                    item.innerHTML = `
                        <span>${word}</span>
                        <div style="display: flex; gap: 0.25rem;">
                            ${wordLevel < 2 ? `<button onclick="updateWordLevel('${word}', ${wordLevel + 1})" class="button button-success" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">✓</button>` : ''}
                            ${wordLevel > 0 ? `<button onclick="updateWordLevel('${word}', ${wordLevel - 1})" class="button button-secondary" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">✗</button>` : ''}
                        </div>
                    `;
                    listContainer.appendChild(item);
                });
            });
        }

        function updateStatsDisplay() {
            const knownWords = Array.from(vocabulary.values()).filter(level => level === 2).length;
            const learningWords = Array.from(vocabulary.values()).filter(level => level === 1).length;
            const totalWords = vocabulary.size;
            const lookedUpWords = lookupHistory.size;

            document.getElementById('stats-known').textContent = knownWords;
            document.getElementById('stats-learning').textContent = learningWords;
            document.getElementById('stats-total').textContent = totalWords;
            document.getElementById('stats-looked-up').textContent = lookedUpWords;

            if (analysis) {
                document.getElementById('current-text-stats').classList.remove('hidden');
                const knownPercentage = Math.round(((analysis.known + analysis.learning * 0.5) / analysis.unique) * 100);
                document.getElementById('text-difficulty').textContent = knownPercentage;
                document.getElementById('text-progress-fill').style.width = knownPercentage + '%';
            } else {
                document.getElementById('current-text-stats').classList.add('hidden');
            }
        }

        // Library management
        function updateLibraryDisplay() {
            const libraryList = document.getElementById('library-list');
            
            if (textLibrary.size === 0) {
                libraryList.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📚</div>
                        <h3>No texts in your library yet</h3>
                        <p>Upload texts in the Text Analysis tab to get started</p>
                    </div>
                `;
                return;
            }

            libraryList.innerHTML = '';
            const gridContainer = document.createElement('div');
            gridContainer.className = 'library-grid';

            Array.from(textLibrary.entries()).forEach(([textId, textData]) => {
                const readCount = readCounts.get(textId) || 0;
                const goal = readingGoals.get(textId) || 3;

                const item = document.createElement('div');
                item.className = 'library-item';
                item.innerHTML = `
                    <div class="library-title">${textData.title}</div>
                    <div class="library-meta">
                        📊 ${textData.wordCount?.toLocaleString()} words<br>
                        📅 ${new Date(textData.dateAdded).toLocaleDateString()}<br>
                        🔄 ${readCount}/${goal} reads ${readCount >= goal ? '✅' : ''}
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button onclick="loadTextForReading('${textId}')" class="button button-primary">👁️ Read</button>
                        <button onclick="loadTextForAnalysis('${textId}')" class="button button-secondary">📊 Analyze</button>
                        <button onclick="deleteText('${textId}')" class="button button-secondary">🗑️</button>
                    </div>
                `;
                gridContainer.appendChild(item);
            });

            libraryList.appendChild(gridContainer);
        }

        function loadTextForReading(textId) {
            const textData = textLibrary.get(textId);
            if (textData) {
                currentText = textData.content;
                currentTextTitle = textData.title;
                currentTextId = textId;
                currentPage = 0;
                showReadingMode();
                showTab('reading');
            }
        }

        function loadTextForAnalysis(textId) {
            const textData = textLibrary.get(textId);
            if (textData) {
                currentText = textData.content;
                currentTextTitle = textData.title;
                currentTextId = textId;
                document.getElementById('text-input').value = textData.content;
                analyzeText();
                showTab('upload');
            }
        }

        function deleteText(textId) {
            if (confirm('Are you sure you want to delete this text?')) {
                textLibrary.delete(textId);
                readCounts.delete(textId);
                readingGoals.delete(textId);
                saveData();
                updateLibraryDisplay();
                
                if (currentTextId === textId) {
                    currentText = '';
                    currentTextTitle = '';
                    currentTextId = '';
                    document.getElementById('text-input').value = '';
                    document.getElementById('analysis-results').classList.add('hidden');
                    showEmptyReading();
                }
            }
        }

        // Reading mode
        function showReadingMode() {
            const readingArea = document.getElementById('reading-area');
            
            if (!currentText) {
                showEmptyReading();
                return;
            }

            const pages = getTextPages();
            const currentPageText = pages[currentPage] || '';

            readingArea.innerHTML = `
                <div class="reading-header">
                    <h3>📖 ${currentTextTitle}</h3>
                    <div class="meta">Page ${currentPage + 1} of ${pages.length} • ${Math.round(((currentPage + 1) / pages.length) * 100)}% complete</div>
                </div>
                
                <div class="reading-text" id="reading-text">
                    ${renderReadingText(currentPageText)}
                </div>
                
                <div class="reading-controls">
                    <button onclick="prevPage()" ${currentPage === 0 ? 'disabled' : ''} class="button button-secondary">← Previous</button>
                    <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                        Page <input type="number" min="1" max="${pages.length}" value="${currentPage + 1}" onchange="goToPage(this.value - 1)" class="page-input"> of ${pages.length}
                    </div>
                    <button onclick="nextPage()" ${currentPage >= pages.length - 1 ? 'disabled' : ''} class="button button-secondary">Next →</button>
                </div>
                
                <div style="margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 1rem; font-size: 0.9rem;">
                    <span>🟢 Known words</span>
                    <span>🟡 Learning</span>
                    <span>🔴 Looked up</span>
                    <span>⚪ Unknown</span>
                </div>
            `;
        }

        function showEmptyReading() {
            const readingArea = document.getElementById('reading-area');
            readingArea.innerHTML = `
                <div class="empty-state">
                    <div class="icon">👁️</div>
                    <h3>No text selected</h3>
                    <p>Choose a text from your library to start reading</p>
                </div>
            `;
        }

        function getTextPages() {
            if (!currentText) return [];
            const words = currentText.split(/\s+/);
            const pages = [];
            
            for (let i = 0; i < words.length; i += wordsPerPage) {
                const pageWords = words.slice(i, i + wordsPerPage);
                pages.push(pageWords.join(' '));
            }
            
            return pages;
        }

        function renderReadingText(text) {
            if (!text) return '';
            
            const words = text.split(/(\s+)/);
            
            return words.map((segment, index) => {
                if (/\s/.test(segment)) {
                    return segment;
                }
                
                const cleanedWord = cleanWord(segment);
                const level = vocabulary.get(cleanedWord) || 0;
                const lookups = lookupHistory.get(cleanedWord) || 0;
                
                let className = 'reading-word';
                if (cleanedWord) {
                    if (level === 2) {
                        className += ' known';
                    } else if (level === 1) {
                        className += ' learning';
                    } else if (lookups > 0) {
                        className += ' new';
                    }
                }
                
                return `<span class="${className}" onclick="showWordPopup('${cleanedWord}')">${segment}</span>`;
            }).join('');
        }

        function nextPage() {
            const pages = getTextPages();
            if (currentPage < pages.length - 1) {
                currentPage++;
                showReadingMode();
                
                if (currentPage === pages.length - 1 && currentTextId) {
                    // Mark text as read when reaching the end
                    const currentCount = readCounts.get(currentTextId) || 0;
                    readCounts.set(currentTextId, currentCount + 1);
                    saveData();
                    updateLibraryDisplay();
                }
            }
        }

        function prevPage() {
            if (currentPage > 0) {
                currentPage--;
                showReadingMode();
            }
        }

        function goToPage(pageNum) {
            const pages = getTextPages();
            const targetPage = Math.max(0, Math.min(pageNum, pages.length - 1));
            currentPage = targetPage;
            showReadingMode();
        }

        // Word popup
        function showWordPopup(word) {
            currentWord = word;
            const level = vocabulary.get(word) || 0;
            const lookups = lookupHistory.get(word) || 0;
            
            // Track lookup
            lookupHistory.set(word, lookups + 1);
            if (!vocabulary.has(word)) {
                vocabulary.set(word, 0);
            }
            saveData();
            
            document.getElementById('popup-word').textContent = word;
            document.getElementById('popup-translation').textContent = getTranslation(word);
            document.getElementById('popup-level').textContent = ['New', 'Learning', 'Known'][level];
            document.getElementById('popup-lookups').textContent = lookups + 1;
            
            document.getElementById('word-overlay').classList.remove('hidden');
            document.getElementById('word-popup').classList.remove('hidden');
            
            updateStatsDisplay();
        }

        function updateWordPopup() {
            if (!currentWord) return;
            
            const level = vocabulary.get(currentWord) || 0;
            const lookups = lookupHistory.get(currentWord) || 0;
            
            document.getElementById('popup-level').textContent = ['New', 'Learning', 'Known'][level];
            document.getElementById('popup-lookups').textContent = lookups;
        }

        function closeWordPopup() {
            document.getElementById('word-overlay').classList.add('hidden');
            document.getElementById('word-popup').classList.add('hidden');
            currentWord = null;
        }

        // Data import/export
        function exportData() {
            const data = {
                vocabulary: [...vocabulary],
                lookupHistory: [...lookupHistory],
                textLibrary: [...textLibrary],
                readCounts: [...readCounts],
                readingGoals: [...readingGoals],
                darkMode: darkMode,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `german-vocab-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.vocabulary) {
                            vocabulary = new Map(data.vocabulary);
                        }
                        if (data.lookupHistory) {
                            lookupHistory = new Map(data.lookupHistory);
                        }
                        if (data.textLibrary) {
                            textLibrary = new Map(data.textLibrary);
                        }
                        if (data.readCounts) {
                            readCounts = new Map(data.readCounts);
                        }
                        if (data.readingGoals) {
                            readingGoals = new Map(data.readingGoals);
                        }
                        if (data.darkMode !== undefined) {
                            darkMode = data.darkMode;
                            document.body.classList.toggle('dark', darkMode);
                            document.querySelector('.dark-toggle').textContent = darkMode ? '☀️' : '🌙';
                        }
                        
                        saveData();
                        updateVocabDisplay();
                        updateStatsDisplay();
                        updateLibraryDisplay();
                        
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
